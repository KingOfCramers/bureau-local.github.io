<!DOCTYPE html>
<html>
<meta charset="utf-8">
<head>
  <title>Pollution</title>
</head>
<body>
</body>
<style>

text {
  font-family: futura;
  font: 18px sans-serif;

  line-height: 1.8em;
  font-family: Futura;
  fill: #474546
}

#textinfo {
  font: 500 50px "Futura";
  fill: #808284
}

#textinfolevel {
  font: 500 30px "Futura";
  fill: #808284
}

#textinfovalue {
  font: 500 150px "Futura";
  fill: #ff5a5d
}

#textinfocontext {
  font: 500 30px "Futura";
  fill: #808284
}

#textInfoExplainer {
  font: 500 30px "Futura";
  fill: #474546
}

#textInfoExplainer2 {
  font: 500 50px "Futura";
  fill: #474546
}

.node circle {
  fill: #ddd;
  stroke: red;
  stroke-width: 2px;
}

.node text {
  text-anchor: middle;
}

.node:hover circle {
  fill: #ef6767;
  fill-opacity: 0.85;
  stroke-width: 2px;
}

</style>

<svg width="1000" height="1600"><g transform="translate(1,1)"></g></svg>
<script src="//d3js.org/d3.v4.0.0-alpha.35.min.js"></script>
<script type="text/javascript">


var svg = d3.select("svg"),
    width = +svg.attr("width"),
    height = +svg.attr("height");

console.log(width);

var format = d3.format(",d");

var pack = d3.pack()
    .size([width - 2, height - 2])
    .padding(20.5);

d3.csv("pollutants-other.csv", type, function(error, data) {
  if (error) throw error;

  var root = d3.hierarchy({children: data})
      .sum(function(d) { return d.value; })
      .sort(function(a, b) { return b.value - a.value; });

  pack(root);

//circle styling

  var node = svg.select("g")
    .selectAll("g")
    .data(root.children)
    .enter().append("g")
      .attr("transform", function(d) { return "translate(" + d.x + "," +
      (d.y-height/7) + ")"; })
      .attr("class", "node");

  node.append("circle")
      .attr("id", function(d) { return "node-" + d.data.id; })
      .attr("r", function(d) { return d.r; })
      .on("mouseover", mouseover);

  node.append("clipPath")
      .attr("id", function(d) { return "clip-" + d.data.id; })
    .append("use")
      .attr("xlink:href", function(d) { return "#node-" + d.data.id + ""; });


   var label = node.append("g").attr("class", "label");


   label.append("text")
        .attr("class", "nodeText")
        .attr("transform", function(d) {return "translate(" + [0, d.r/8] + ")"; })
        .style("font-size", function(d) {return d.r/3.5})
        .text(function(d) { return d.data.id; })
        .call(wrap, "node");

        label.append("text")
             .attr("class", "nodeNumber")
             .attr("transform", function(d) {return "translate(" + [0, -d.r/7] + ")"; })
             .style("font-size", function(d) {return d.r/6})
             .text(function(d) {return d.value; });


//heading styling

  var titles = svg.append("g")
      .attr("class", "notes")
      .attr("transform", "translate(" + [50, 50] + ")");

  titles.append("text")
       .attr("id", "textinfo")
      //  .attr("opacity", 0)
       .text("Agriculture's 15 Most Prevalent Pollutants");

  titles.append("text")
        .attr("id", "textinfolevel")
        .attr("transform", "translate(" + [0, 50] + ")")
        //  .attr("opacity", 0)
        .text("2010 -16");

  }); // closes the d3.csv call

   var logo = svg.append("g").attr("class", "logo-image");
   var logoSize = 96

   logo.append("svg:image")
      .attr("x", width-logoSize-25)
      .attr("y", height-logoSize-1430)
      .attr("width", logoSize)
      .attr("height", logoSize)
      .attr("xlink:href", "TBIJlogo2.jpeg")


//number styling
    var number = svg.append("g")
          .attr("class", "notes2")
          .attr("transform", "translate(" + [50, height-495] + ")");


      number.append("text")
       .attr("id", "textinfovalue")
          //  .attr("opacity", 0)
          .text("2874");
          // closes the d3.csv call


       function mouseover(circle) {
        d3.select("#textinfovalue").text(function(d) { return circle.data.value})
        d3.select("#textInfoExplainer").text(function(d) { return circle.data.context}).call(wrap, width/1.05)
      }

          function type(d) {
            return (d.value = +d.value) ? d : null;
          }

    var number = svg.append("g")
          .attr("class", "notes")
          .attr("transform", "translate(" + [400, height-495] + ")");


          number.append("text")
             .attr("id", "textinfocontext")
                //  .attr("opacity", 0)
                .text("reported incidents of pollution overall");
                // closes the d3.csv call

    var par = svg.append("g")
             .attr("class", "notes3")
             .attr("transform", "translate(" + [50, height-360] + ")");

        par.append("text")
          .attr("id", "textInfoExplainer")
          .text("Click on the bubble for more information...");

          var par = svg.append("g")
                .attr("class", "notes3")
                .attr("transform", "translate(" + [50, height-410] + ")");


                par.append("text")
                   .attr("id", "textInfoExplainer2")
                      //  .attr("opacity", 0)
                      .text("What is their enviromental impact?");
                      // closes the d3.csv call
             function type(d) {
               return (d.value = +d.value) ? d : null;
             }



                // wrap text function - I learned this nifty trick from the FT
                  function wrap(text, width) {
                    text.each(function() {
                      console.log(width)
                      if (width=="node") {
                          width = this.parentNode.parentNode.querySelector("circle").getAttribute("r")*1.9
                          wasTrue = "y"
                      }
                      console.log(width)
                      var text = d3.select(this),
                          words = text.text().split(/\s+/).reverse(),
                          word,
                          line = [],
                          lineNumber = 0,
                          lineHeight = 1.3, // ems
                          y = text.attr("y"),
                          dy = parseFloat(text.attr("dy"));
                          if(!dy){dy = 0}else{dy = dy};
                          var tspan = text.text(null).append("tspan").attr("x", 0).attr("y", y).attr("dy", dy + "em");
                      while (word = words.pop()) {
                        line.push(word);
                        tspan.text(line.join(" "));
                        if (tspan.node().getComputedTextLength() > width) {
                          line.pop();
                          tspan.text(line.join(" "));
                          line = [word];
                          // console.log(line);
                          tspan = text.append("tspan").attr("x", 0).attr("y", y).attr("dy", lineHeight + dy + "em").text(word);
                        }
                      }
                        if (wasTrue == "y") {
                          width = "node"
                        }
                    });
                  }


</script>
</html>
