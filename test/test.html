<!DOCTYPE html>
<html>
  <meta charset="utf-8">
  <head>
    <title>Vis</title>
    <script src="//d3js.org/d3.v3.min.js" charset="utf-8"></script></script>
    <script src="//d3js.org/topojson.v1.min.js"></script>
    <script src="https://d3js.org/queue.v1.min.js"></script>
    <script src="../post-frame-height.js"></script>
    <style>

      body {
        font-size: 14px;
        font-family: "Futura",sans-serif;
      }
      
      .subunit.SCT { fill: #d9dbf1; }
      .subunit.WLS { fill: #d9dbf1; }
      .subunit.NIR { fill: #d9dbf1; }
      .subunit.ENG { fill: #d9dbf1; }
      .subunit.IRL { display: none; }

      .urban { fill: #888888;}
      
      
      .subunit-boundary {
        fill: none;
        stroke: #2a2d34;
        stroke-dasharray: 2,2;
        stroke-linejoin: round;
      }
      
      .subunit-boundary.IRL {
        stroke: #aaa;
      
      }
      
      .subunit-label {
        fill: #2a2d34;
        fill-opacity: .6;
        font-size: 20px;
        font-weight: 300;
        text-anchor: middle;
      }
      
      .oneofthem {
      	stroke-width: 1px;
        stroke: #ff5a5d;
        fill: #ff5a5d;
        fill-opacity: .6;
      }
      
      .axis {
        fill: gray;
        -webkit-user-select: none;
        -moz-user-select: none;
        user-select: none;
      }
      
      .axis .slider-bar {
        stroke: gray;
        stroke-width: 4px;
        stroke-linecap: round;
      }

      .progress-bar {
        stroke: #ff5a5d;
        stroke-width: 4px;
        stroke-linecap: round;
      }
      
      .slider .handle circle {
        fill: #ff5a5d;
        stroke-linecap: round;
        pointer-events: none;
      }
      
      .slider .handle text {
        fill: #ff5a5d;
        text-align: center;
        font-size: 18px;
      }

      .ticker {
        fill: #ff5a5d;
        text-align: center;
        font-size: 36px;
      }

      .ticknumber {
        font-size: 144px;
      }

      .play-button {
        fill: #ff5a5d;
      }

      .playbtn {
        position: absolute;
        top: 50px;
      }

    </style>
  </head>

  <body></body>
    
  <script>
  
  // blocks used http://bl.ocks.org/cmdoptesc/fc0e318ce7992bed7ca8
  // blocks used http://bl.ocks.org/zanarmstrong/ddff7cd0b1220bc68a58
  // code used for play pause translate along path http://plnkr.co/edit/D8JxZapNC62wcXulZ0nK?p=preview
  // ease linear
  
  formatDate = d3.time.format("%b %Y");

  function reformat (d) {
   return d3.time.format('%Y-%m-%d')(d3.time.format('%d/%m/%Y').parse(d));
  }

  // vanilla JS window width and height
  var w=window,
  d=document,
  e=d.documentElement,
  g=d.getElementsByTagName('body')[0],
  x=w.innerWidth||e.clientWidth||g.clientWidth,
  y=w.innerHeight||e.clientHeight||g.clientHeight;
  
  // parameters
  var margin = {
      top: 50,
      right: 50,
      bottom: 50,
      left: 25
    },
    width = x - margin.left - margin.right,
    height = 1100 - margin.bottom - margin.top;
  
  var projection = d3.geo.albers()
      .center([0, 55])
      .rotate([4, 0])
      .parallels([50, 60])
      .scale(1200 * 4)
      .translate([width / 2, height / 2]);
  
  var path = d3.geo.path()
      .projection(projection);
  
  // scale function
  var timeScale = d3.time.scale()
      .domain([new Date('2002-12-26'), new Date('2017-03-28')])
      .range([75, width])
      .clamp(true);
  
  // initial value
  var startValue = timeScale(new Date('2002-12-26'));
      startingValue = new Date('2002-12-26');

  // icons
  var playWidth = 30,
      playD = 'M' + [
        0, 0,
        playWidth/1.2, playWidth/2,
        0, playWidth,
        0, 0].join(','),
      pauseD = 'M' + [
        0, 0,
        playWidth/3, 0,
        playWidth/3, playWidth,
        0, playWidth
      ].join(',') + 'Z M' + [
        (playWidth / 2) + 0, 0,
        (playWidth / 2) + playWidth/3, 0,
        (playWidth / 2) + playWidth/3, playWidth,
        (playWidth / 2) + 0, playWidth
      ].join(',');

  play = false
  
  var svg = d3.select("body").append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
      .append("g")
      // classic transform to position g
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
  
  
  function chart(uk, urban){
  
    // ---------- MAP ----------
  
    svg.selectAll(".subunit")
      .data(topojson.feature(uk, uk.objects.subunits).features)
      .enter().append("path")
      .attr("class", function(d) { return "subunit " + d.id; })
      .attr("d", path);
  
    svg.append("path")
      .datum(topojson.mesh(uk, uk.objects.subunits, function(a, b) { return a !== b && a.id !== "IRL"; }))
      .attr("d", path)
      .attr("class", "subunit-boundary");
  
    svg.append("path")
      .datum(topojson.mesh(uk, uk.objects.subunits, function(a, b) { return a === b && a.id === "IRL"; }))
      .attr("d", path)
      .attr("class", "subunit-boundary IRL");
  
    svg.selectAll(".subunit-label")
      .data(topojson.feature(uk, uk.objects.subunits).features)
      .enter().append("text")
      .attr("class", function(d) { return "subunit-label " + d.id; })
      .attr("transform", function(d) { return "translate(" + path.centroid(d) + ")"; })
      .attr("dy", ".35em")
      .text(function(d) { return d.properties.name; });

    svg.selectAll(".urban")
      .data(topojson.feature(urban, urban.objects.urban).features)
      .enter().append("path")
      .attr("class", function(d) { return "urban"; })
      .attr("d", path);
 
    // ---------- END OF MAP ----------

    // ---------- TICKER -----------

    var ticker = svg.append("g")
        .attr("class", "ticker");

    ticker.append("text")
          .attr("class", "ticknumber")
          .attr("transform", "translate(" + 0 + "," + height/5 + ")")
          .text("0");

    ticker.append("text")
          .attr("class", "ticklabel")
          .attr("transform", "translate(" + 0 + "," + (height/5 + 50) + ")")
          .text("Thats a lot of something");

    // ---------- END OF TICKER -----------
  
    // ---------- SLIDER ----------
  
    var brush = d3.svg.brush()
        .x(timeScale)
        .extent([startingValue, startingValue])
        .on("brush", brushed);
  
    // display the slider
    svg.append("g")
      .attr("class", "x axis")
      // put at the top of the vis ouain lol
      .attr("transform", "translate(0," + 0 + ")")
      // inroduce axis
      .call(d3.svg.axis()
        .scale(timeScale)
        .orient("bottom")
        .tickFormat(function(d) {
          return formatDate(d);
        })
        .tickSize(0)
        .tickPadding(20)
        .tickValues([timeScale.domain()[0], timeScale.domain()[1]]))
        .select(".domain")
        .select(function() {
          return this.parentNode.appendChild(this.cloneNode(true));
        })
        .attr("class", "slider-bar");

    // ---------- progress bar ----------

    var progress = svg.append('rect')
        .attr('class', 'progress-bar')
        // put at the top of the vis ouain lol
        // .attr("transform", "translate(75," + 0 + ")")
        .attr('x', 75)
        .attr('width', 0)
        .attr('height', 1)
        .attr('rx', 1)
        .attr('ry', 1);

    // ---------- end progress bar ----------
  
    var slider = svg.append("g")
        .attr("class", "slider")
        .call(brush);
  
    slider.selectAll(".extent,.resize")
      .remove();
  
    slider.select(".background")
      .attr("height", 20)
      .attr("transform", "translate(0,-10)")
      .style("cursor", "pointer");
  
    var handle = slider.append("g")
        .attr("class", "handle")
        .style("cursor", "pointer");
  
    handle.append("circle")
      .attr("transform", "translate(0," + 0 + ")")
      .attr("r", 10);
  
    handle.append("text")
      .text(startingValue)
      .attr("transform", "translate(" + (-45) + " ," + (0 - 15) + ")");
  
    slider
      .call(brush.event);
  
    // ---------- END OF SLIDER ----------

    var playButtonG = svg.append('g')
        .attr('transform', 'translate(' + [0, -playWidth/2] + ')');
    
    var playIcon = playButtonG.append('path')
        .attr('transform', 'translate(0, 0)')
        .attr('d', playD)
        .attr('class', 'play-button');
   
    var playRect = playButtonG.append('rect')
        .attr('fill', 'none')
        .attr('pointer-events', 'visible')
        .attr('width', 15)
        .attr('height', 15)
        .style('cursor', 'pointer')
        .on('click', function() {
          if (play == true) {
            playIcon.attr('d', play ? playD : pauseD);
            play = false
            handle.transition()
                  .duration(0);
            setTimeout(function(){
                  pauseValues.lastT = pauseValues.currentT;
                }, 100);
          } else {
            // nothing should be displayed at first
            if (pauseValues.currentT == 0) {            
              var allofthem = svg.selectAll(".oneofthem").remove();
            }
            playIcon.attr('d', play ? playD : pauseD);
            play = true
            transition();
          }

        });

    var pauseValues = {
      lastT: 0,
      currentT: 0
    };

    function transition() {
      handle.transition()
          .duration(15000)
          .ease("linear") // this makes the time equal along the transition.
          .attrTween("transform", translateAlong(document.getElementsByClassName("slider-bar")[0])); // lol this is a bit clunky innit
    }

    // Returns an attrTween for translating along the specified path element.
    function translateAlong(path) {
      var l = path.getTotalLength();
      return function(d, i, a) {
        return function(t) {
          t += pauseValues.lastT;
          var p = path.getPointAtLength(t * l);
          pauseValues.currentT = t;

          // ---------- update the data and ticker on play ----------

          var value = timeScale.invert(p.x);
        
          newdata = allofthemdata.filter( function(d) {
            return timeScale(new Date(reformat(d.date))) < timeScale(value)
          });
          
          handle.attr("transform", "translate(" + timeScale(value) + ",0)");
          progress.attr("width", timeScale(value)-75);
          handle.select("text").text(formatDate(value));

          ticker.select("text").text(newdata.length);
          
          displayallofthem(newdata);

          // ---------------------

          // do this at the end
          if (pauseValues.currentT == 1) {
            progress.attr("width", p.x-75);
            playIcon.attr('d', playD);
            play = false
            pauseValues = {
              lastT: 0,
              currentT: 0
            };
          };

          return "translate(" + p.x + "," + p.y + ")";
        };
      };
    }
  
    // ---------- UPDATING allofthem ----------
  
    function displayallofthem(data) {
  
      var allofthem = svg.selectAll(".oneofthem")
        .data(data);
  
      allofthem.enter().append("circle")
        .attr("class", "oneofthem")
        .attr("cx", function(d) {
          return projection([d.longitude, d.latitude])[0];
        })
        .attr("cy", function(d) {
          return projection([d.longitude, d.latitude])[1];
        })
        .attr("r", 2) // or 1 ?!?
        .transition().duration(400) // or 500 ?!?
        .attr("r", 4) // or 5 ?!?;
  
      allofthem.exit()
        .transition().duration(100) // or 300 ?!?
        .attr("r",0) // or 1 ?!?
        .remove();
  
    };
  
    // function that updates the slider/ticker and chooses the relevant oneofthem to display
    function brushed() {

      if (play == true) {
        playIcon.attr('d', play ? playD : pauseD);
        play = false
        handle.transition()
              .duration(0);
        setTimeout(function(){
              pauseValues.lastT = pauseValues.currentT;
            }, 100);
      }


      setTimeout(function(){
                  pauseValues.lastT = pauseValues.currentT;
      }, 100);
      
      var value = brush.extent()[0];
  

      if (d3.event.sourceEvent) { // not a programmatic event
        value = timeScale.invert(d3.mouse(this)[0]);
        brush.extent([value, value]);
      }
  
      newdata = allofthemdata.filter( function(d) {
        return timeScale(new Date(reformat(d.date))) < timeScale(value)
      })
  
      handle.attr("transform", "translate(" + timeScale(value) + ",0)");
      progress.attr("width", timeScale(value)-75);
      handle.select("text").text(formatDate(value));

      ticker.select("text").text(newdata.length);
  
      displayallofthem(newdata);
  
    };
  
    // ---------- END OF UPDATING allofthem ----------
  
  }; // end of draw()
  
  function init() {
    queue()
      .defer(d3.json, "uk.json")
      .defer(d3.json, "topourban.json")
      .defer(d3.csv, "data.csv")
      .await(function(error, uk, urban, allofthemdata){
  
        window.allofthemdata = allofthemdata
  
        chart(uk, urban)
  
      });
  };


  init();
  

  </script>
</html>
